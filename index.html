<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Discord Emoji Generator Ultra</title>
    <link href="https://fonts.googleapis.com/css2?family=DotGothic16&family=M+PLUS+Rounded+1c:wght@800&family=Noto+Sans+JP:wght@900&family=Reggae+One&family=RocknRoll+One&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #313338;
            --panel: #2b2d31;
            --input: #1e1f22;
            --accent: #5865f2;
            --success: #248046;
            --text: #f2f3f5;
            --muted: #b5bac1;
        }

        body {
            font-family: 'Helvetica Neue', Arial, 'Noto Sans JP', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* „É¨„Ç§„Ç¢„Ç¶„Éà */
        .sidebar {
            width: 380px;
            background: var(--panel);
            border-right: 1px solid #1e1f22;
            display: flex;
            flex-direction: column;
            padding: 20px;
            overflow-y: auto;
            box-shadow: 2px 0 10px rgba(0,0,0,0.2);
        }

        .main-view {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
            gap: 30px;
            overflow-y: auto;
        }

        /* UIË¶ÅÁ¥† */
        .section {
            background: var(--input);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        h3 { font-size: 0.8rem; text-transform: uppercase; color: var(--muted); margin: 0 0 12px 0; letter-spacing: 0.5px; }
        
        textarea {
            width: 100%; height: 80px; background: var(--bg); border: 1px solid #111;
            color: white; padding: 10px; border-radius: 4px; resize: none; font-size: 1rem; box-sizing: border-box;
        }

        .control-row { display: flex; align-items: center; gap: 10px; margin-top: 10px; }
        .control-row label { font-size: 0.85rem; flex: 1; color: var(--muted); }
        
        input[type="range"] { flex: 2; accent-color: var(--accent); }
        select, input[type="color"] { background: var(--bg); border: 1px solid #111; color: white; padding: 5px; border-radius: 4px; }

        /* Á∏ÅÂèñ„Çä„É™„Çπ„Éà */
        .stroke-item {
            display: flex; align-items: center; gap: 8px; background: var(--panel);
            padding: 8px; border-radius: 4px; margin-top: 5px; border: 1px solid #444;
        }

        /* „Éó„É¨„Éì„É•„Éº */
        .canvas-container {
            position: relative;
            padding: 10px;
            background: repeating-conic-gradient(#3a3a3a 0% 25%, #444 0% 50%) 50% / 20px 20px;
            border: 4px solid var(--panel);
            border-radius: 8px;
        }

        .discord-mockup {
            background: var(--bg);
            width: 100%;
            max-width: 500px;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #444;
        }

        .chat-msg { display: flex; gap: 15px; margin-bottom: 15px; }
        .avatar { width: 40px; height: 40px; background: #7289da; border-radius: 50%; }
        .msg-content { flex: 1; }
        .user-info { font-weight: bold; margin-bottom: 4px; font-size: 0.9rem; }
        .user-info span { font-weight: normal; color: var(--muted); font-size: 0.75rem; margin-left: 8px; }

        .btn {
            cursor: pointer; border: none; border-radius: 4px; font-weight: bold; transition: 0.2s;
        }
        .btn-add { background: var(--accent); color: white; padding: 8px; width: 100%; margin-top: 10px; }
        .btn-dl { background: var(--success); color: white; padding: 15px 40px; font-size: 1.1rem; }
        .btn-remove { background: #ed4245; color: white; padding: 2px 8px; }
        .btn:hover { opacity: 0.8; }

        .emoji-jumbo { width: 48px; height: 48px; object-fit: contain; }
    </style>
</head>
<body>

    <div class="sidebar">
        <h2 style="margin:0 0 20px 0; font-size:1.2rem;">üé® Emoji Maker</h2>
        
        <div class="section">
            <h3>Text</h3>
            <textarea id="textInput">Ë¶ãÂàá„Çå„Çì&#10;„Éá„Ç´ÊñáÂ≠ó</textarea>
            <div class="control-row">
                <label>Font</label>
                <select id="fontFamily" style="flex:2;">
                    <option value="'Noto Sans JP'">Noto Sans JP</option>
                    <option value="'RocknRoll One'">RocknRoll One</option>
                    <option value="'Reggae One'">Reggae One</option>
                    <option value="'DotGothic16'">DotGothic16</option>
                    <option value="'Impact'">Impact</option>
                </select>
            </div>
            <div class="control-row">
                <label>ÊâãÊåÅ„Å°„Éï„Ç©„É≥„Éà</label>
                <input type="file" id="fontUpload" accept=".ttf,.otf,.woff" style="width:120px; font-size:0.7rem;">
            </div>
        </div>

        <div class="section">
            <h3>Style</h3>
            <div class="control-row">
                <label>Âü∫Êú¨„Çµ„Ç§„Ç∫</label>
                <input type="range" id="fontSize" min="30" max="200" value="100">
            </div>
            <div class="control-row">
                <label>Ë°åÈñì</label>
                <input type="range" id="lineHeight" min="0.5" max="1.5" step="0.05" value="0.9">
            </div>
            <div class="control-row">
                <label>„Ç∞„É©„Éá</label>
                <input type="checkbox" id="useGrad" checked>
                <input type="color" id="col1" value="#00ffcc">
                <input type="color" id="col2" value="#0066ff">
            </div>
        </div>

        <div class="section">
            <h3>Strokes (Á∏ÅÂèñ„Çä)</h3>
            <div id="strokeList"></div>
            <button class="btn btn-add" id="addStroke">+ Á∏ÅÂèñ„Çä„É¨„Ç§„É§„ÉºËøΩÂä†</button>
        </div>

        <div class="section">
            <h3>Shadow</h3>
            <div class="control-row">
                <label>ÂΩ±</label>
                <input type="checkbox" id="useShadow" checked>
                <input type="color" id="shadowCol" value="#000000">
            </div>
            <div class="control-row">
                <label>„Åº„Åã„Åó</label>
                <input type="range" id="shadowBlur" min="0" max="15" value="5">
            </div>
        </div>
    </div>

    <div class="main-view">
        <div class="canvas-container">
            <canvas id="canvas" width="128" height="128"></canvas>
        </div>

        <div class="discord-mockup">
            <div class="chat-msg">
                <div class="avatar"></div>
                <div class="msg-content">
                    <div class="user-info">Gemini <span>‰ªäÊó• 21:00</span></div>
                    <img id="previewImg" class="emoji-jumbo" src="">
                </div>
            </div>
        </div>

        <button class="btn btn-dl" id="dlBtn">ÈÄèÈÅéPNG„ÇíÊõ∏„ÅçÂá∫„Åó</button>
        <p style="color:var(--muted); font-size:0.8rem;">‚Äª256KB‰ª•ÂÜÖ„Å´Ëá™ÂãïË™øÊï¥„Åï„Çå„Åæ„Åô</p>
    </div>

<script>
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const preview = document.getElementById('previewImg');

    let strokes = [
        { color: '#ffffff', width: 10 },
        { color: '#000000', width: 5 }
    ];

    // UIÂàùÊúüÂåñ
    function initStrokes() {
        const list = document.getElementById('strokeList');
        list.innerHTML = '';
        strokes.forEach((s, i) => {
            const item = document.createElement('div');
            item.className = 'stroke-item';
            item.innerHTML = `
                <input type="color" value="${s.color}" oninput="strokes[${i}].color=this.value; draw()">
                <input type="range" min="1" max="30" value="${s.width}" oninput="strokes[${i}].width=parseInt(this.value); draw()">
                <button class="btn btn-remove" onclick="strokes.splice(${i},1); initStrokes(); draw()">√ó</button>
            `;
            list.appendChild(item);
        });
    }

    function draw() {
        ctx.clearRect(0, 0, 128, 128);
        
        const text = document.getElementById('textInput').value;
        const lines = text.split('\n');
        const font = document.getElementById('fontFamily').value;
        const baseSize = parseInt(document.getElementById('fontSize').value);
        const lh = parseFloat(document.getElementById('lineHeight').value);

        ctx.font = `900 ${baseSize}px ${font}`;
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.lineJoin = 'round';

        // --- Ë∂ÖÈáçË¶ÅÔºöË¶ãÂàá„ÇåÈò≤Ê≠¢„É≠„Ç∏„ÉÉ„ÇØ ---
        // 1. „Åæ„ÅöÁèæÂú®„ÅÆË®≠ÂÆö„ÅßÂÖ®‰Ωì„ÅÆ„Çµ„Ç§„Ç∫„ÇíÊ∏¨„Çã
        let maxLineWidth = 0;
        lines.forEach(l => {
            const w = ctx.measureText(l).width;
            if(w > maxLineWidth) maxLineWidth = w;
        });

        const totalStroke = strokes.reduce((a, b) => a + b.width, 0);
        const fullWidth = maxLineWidth + (totalStroke * 2);
        const fullHeight = (lines.length * baseSize * lh) + (totalStroke * 2);

        // 2. 128px„Å´Âèé„Åæ„Çã„Çà„ÅÜ„Å´„Çπ„Ç±„Éº„É´„ÇíË®àÁÆóÔºàÁ∏¶Ê®™„ÅÆ„ÅÜ„Å°„ÄÅ„Çà„Çä„ÅØ„ÅøÂá∫„Å¶„ÅÑ„ÇãÊñπ„Å´Âêà„Çè„Åõ„ÇãÔºâ
        const scale = Math.min(120 / fullWidth, 120 / fullHeight, 1.0);

        ctx.save();
        ctx.translate(64, 64);
        ctx.scale(scale, scale); // „Åì„Åì„ÅßÂÖ®‰Ωì„ÇíÊû†ÂÜÖ„Å´ÂúßÁ∏ÆÔºÅ

        const drawText = (mode, sIdx) => {
            lines.forEach((line, i) => {
                const y = (i - (lines.length - 1) / 2) * (baseSize * lh);
                if (mode === 'shadow') {
                    ctx.shadowColor = document.getElementById('shadowCol').value;
                    ctx.shadowBlur = document.getElementById('shadowBlur').value;
                    ctx.shadowOffsetX = 3; ctx.shadowOffsetY = 3;
                    ctx.strokeText(line, 0, y);
                    ctx.fillText(line, 0, y);
                } else if (mode === 'stroke') {
                    let currentSum = 0;
                    for(let j=0; j<=sIdx; j++) currentSum += strokes[j].width;
                    ctx.strokeStyle = strokes[sIdx].color;
                    ctx.lineWidth = currentSum * 2;
                    ctx.strokeText(line, 0, y);
                } else {
                    if (document.getElementById('useGrad').checked) {
                        const grad = ctx.createLinearGradient(0, -baseSize/2, 0, baseSize/2);
                        grad.addColorStop(0, document.getElementById('col1').value);
                        grad.addColorStop(1, document.getElementById('col2').value);
                        ctx.fillStyle = grad;
                    } else {
                        ctx.fillStyle = document.getElementById('col1').value;
                    }
                    ctx.fillText(line, 0, y);
                }
            });
        };

        // ÊèèÁîªÈ†ÜÔºöÂΩ± -> Â§ñ„Éï„ÉÅ -> ÂÜÖ„Éï„ÉÅ -> Â°ó„Çä
        if(document.getElementById('useShadow').checked) drawText('shadow');
        for(let i=strokes.length-1; i>=0; i--) drawText('stroke', i);
        drawText('fill');

        ctx.restore();
        preview.src = canvas.toDataURL();
    }

    // „Ç§„Éô„É≥„Éà
    document.getElementById('addStroke').onclick = () => {
        strokes.push({color:'#ffffff', width:5});
        initStrokes();
        draw();
    };

    document.getElementById('fontUpload').onchange = (e) => {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = (ev) => {
            const f = new FontFace('CustomFont', ev.target.result);
            f.load().then(loaded => {
                document.fonts.add(loaded);
                document.getElementById('fontFamily').innerHTML += `<option value="CustomFont">üìÇ ${file.name}</option>`;
                document.getElementById('fontFamily').value = "CustomFont";
                draw();
            });
        };
        reader.readAsArrayBuffer(file);
    };

    document.getElementById('dlBtn').onclick = () => {
        const link = document.createElement('a');
        link.download = 'emoji.png';
        link.href = canvas.toDataURL();
        link.click();
    };

    document.querySelectorAll('input, select, textarea').forEach(el => {
        el.oninput = draw;
    });

    window.onload = () => { initStrokes(); setTimeout(draw, 300); };
</script>
</body>
</html>
