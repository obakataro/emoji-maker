<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emoji Generator Pro - Storage Edition</title>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+2:wght@100..900&family=Noto+Sans+JP:wght@100..900&family=Reggae+One&family=RocknRoll+One&family=Dela+Gothic+One&family=Yuji+Syuku&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #1e1f22; --panel: #2b2d31; --card: #313338;
            --accent: #5865f2; --success: #248046; --danger: #ed4245; 
            --text: #f2f3f5; --muted: #b5bac1; --border: #111;
        }
        body {
            font-family: 'Noto Sans JP', sans-serif; background: var(--bg); color: var(--text);
            margin: 0; display: flex; height: 100vh; overflow: hidden; font-size: 13px;
        }

        /* Layout */
        .sidebar { width: 420px; background: var(--panel); border-right: 1px solid var(--border); display: flex; flex-direction: column; }
        .main { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #111; position: relative; }

        /* Tabs */
        .tabs { display: flex; background: #000; }
        .tab-btn {
            flex: 1; padding: 12px; background: transparent; border: none; color: var(--muted);
            cursor: pointer; border-bottom: 3px solid transparent; font-weight: bold; transition: 0.2s;
        }
        .tab-btn.active { color: var(--accent); border-bottom-color: var(--accent); background: var(--panel); }

        /* Scroll Content */
        .scroll-content { flex: 1; overflow-y: auto; padding: 15px; }

        /* UI Components */
        .card { background: var(--card); border-radius: 8px; padding: 12px; margin-bottom: 12px; border: 1px solid #444; }
        .card h3 { margin: 0 0 10px 0; font-size: 0.75rem; color: var(--accent); text-transform: uppercase; border-bottom: 1px solid #444; padding-bottom: 5px; display: flex; justify-content: space-between; }
        
        .row { display: flex; align-items: center; gap: 8px; margin-top: 8px; }
        .row label { flex: 1; color: var(--muted); font-size: 0.8rem; }
        
        input, select, textarea { background: #111; border: 1px solid #555; color: white; border-radius: 4px; padding: 4px; }
        input[type="range"] { flex: 2; height: 6px; accent-color: var(--accent); cursor: pointer; }
        input[type="color"] { width: 30px; height: 30px; padding: 0; border: none; cursor: pointer; }
        textarea { width: 100%; height: 50px; font-size: 1.1rem; font-weight: bold; box-sizing: border-box; }

        /* Preset Manager Styles */
        .preset-list { display: flex; flex-direction: column; gap: 5px; margin-top: 10px; max-height: 150px; overflow-y: auto; }
        .preset-item {
            display: flex; align-items: center; gap: 8px; background: #222; padding: 5px 8px; border-radius: 4px;
        }
        .preset-name { flex: 1; cursor: pointer; font-size: 0.85rem; }
        .preset-name:hover { color: var(--accent); }

        /* Canvas Area */
        .canvas-area {
            position: relative; padding: 20px; border-radius: 12px;
            background: repeating-conic-gradient(#333 0% 25%, #444 0% 50%) 50% / 20px 20px;
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
        }
        .canvas-area.interactive { border: 2px solid var(--accent); cursor: move; }

        /* Buttons */
        .btn { border: none; border-radius: 4px; padding: 8px; cursor: pointer; font-weight: bold; color: white; transition: 0.2s; }
        .btn-blue { background: var(--accent); }
        .btn-green { background: var(--success); }
        .btn-red { background: var(--danger); }
        .btn-gray { background: #4e5058; }
        .btn-sm { padding: 2px 6px; font-size: 0.75rem; }

        .hidden { display: none !important; }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="tabs">
        <button class="tab-btn active" id="tab-btn-main" onclick="setTab('main')">åŸºæœ¬</button>
        <button class="tab-btn" id="tab-btn-style" onclick="setTab('style')">è£…é£¾</button>
        <button class="tab-btn" id="tab-btn-craft" onclick="setTab('craft')">è·äºº</button>
        <button class="tab-btn" id="tab-btn-save" onclick="setTab('save')">ä¿å­˜/ç®¡ç†</button>
    </div>

    <div class="scroll-content">
        <div class="card">
            <h3>TEXT</h3>
            <textarea id="textInput">æœ€å¼·&#10;çµµæ–‡å­—</textarea>
            <div class="row">
                <select id="fontFamily" style="flex:1">
                    <option value="'Dela Gothic One'">Dela Gothic (æ¥µå¤ª)</option>
                    <option value="'Noto Sans JP'">Noto Sans</option>
                    <option value="'RocknRoll One'">RocknRoll</option>
                    <option value="'Yuji Syuku'">æ˜æœä½“</option>
                </select>
                <input type="range" id="fontWeight" min="100" max="900" step="100" value="900" style="width:80px">
            </div>
        </div>

        <div id="pane-main" class="tab-pane">
            <div class="card">
                <h3>Layout</h3>
                <div class="row"><label>ã‚µã‚¤ã‚º</label><input type="range" id="globalSize" min="40" max="250" value="120"></div>
                <div class="row"><label>è¡Œé–“</label><input type="range" id="lineHeight" min="0.5" max="1.5" step="0.05" value="0.85"></div>
                <div class="row"><label>æ–œä½“</label><input type="range" id="skew" min="-45" max="45" value="0"></div>
            </div>
            <div class="card">
                <h3>Colors</h3>
                <div class="row">
                    <input type="color" id="col1" value="#FFFFFF">
                    <input type="color" id="col2" value="#00CCFF">
                    <input type="color" id="col3" value="#0066FF">
                </div>
                <div class="row"><label>è§’åº¦</label><input type="range" id="gradAngle" min="0" max="360" value="90"></div>
                <div class="row"><input type="checkbox" id="useRainbow"> <label>ğŸŒˆ è™¹è‰²ãƒ¢ãƒ¼ãƒ‰</label></div>
            </div>
        </div>

        <div id="pane-style" class="tab-pane hidden">
            <div class="card">
                <h3>Background</h3>
                <select id="bgType" style="width:100%">
                    <option value="none">ãªã—</option>
                    <option value="rect">å››è§’</option>
                    <option value="round">è§’ä¸¸</option>
                    <option value="burst">é›†ä¸­ç·š</option>
                </select>
                <div class="row"><label>èƒŒæ™¯è‰²</label><input type="color" id="bgColor" value="#000000"></div>
            </div>
            <div class="card">
                <h3>Strokes</h3>
                <div id="strokeList"></div>
                <button class="btn btn-gray btn-sm" onclick="addStroke()" style="width:100%; margin-top:5px;">+ ç¸å–ã‚Šè¿½åŠ </button>
            </div>
            <div class="card">
                <h3>Effects</h3>
                <div class="row"><label>è³ªæ„Ÿ</label>
                    <select id="textureMode">
                        <option value="none">ãªã—</option>
                        <option value="noise">ãƒã‚¤ã‚º</option>
                        <option value="gloss">å…‰æ²¢</option>
                    </select>
                </div>
                <div class="row"><input type="checkbox" id="useNeon"> <label>ãƒã‚ªãƒ³ç™ºå…‰</label></div>
            </div>
        </div>

        <div id="pane-craft" class="tab-pane hidden">
            <div class="card">
                <h3>Craftsman Controls</h3>
                <div id="charGrid" style="display:flex; gap:5px; flex-wrap:wrap; margin-bottom:10px;"></div>
                <div class="row"><button class="btn btn-blue" onclick="copyToAll()" style="flex:1">å…¨æ–‡å­—ã«ã‚³ãƒ”ãƒ¼</button></div>
                <div class="row"><button class="btn btn-gray" onclick="randomize()" style="flex:1">ãƒ©ãƒ³ãƒ€ãƒ æ•£ã‚‰ã—</button></div>
            </div>
            <div class="card" id="charDetail" style="opacity:0.5; pointer-events:none;">
                <h3 id="selCharName">æ–‡å­—æœªé¸æŠ</h3>
                <div class="row"><label>æ‹¡å¤§</label><input type="range" id="c_scale" min="0.5" max="2.5" step="0.1" value="1"></div>
                <div class="row"><label>å›è»¢</label><input type="range" id="c_rot" min="-180" max="180" value="0"></div>
                <div class="row"><input type="checkbox" id="c_useCol"> <label>å€‹åˆ¥è‰²</label><input type="color" id="c_col" value="#ff0000"></div>
            </div>
        </div>

        <div id="pane-save" class="tab-pane hidden">
            <div class="card">
                <h3>My Presets</h3>
                <div class="row">
                    <input type="text" id="presetNameInput" placeholder="ã‚¹ã‚¿ã‚¤ãƒ«åã‚’å…¥åŠ›" style="flex:1">
                    <button class="btn btn-green btn-sm" onclick="saveCurrentToPresets()">ä¿å­˜</button>
                </div>
                <div class="preset-list" id="presetList">
                    </div>
            </div>
            <div class="card">
                <h3>External Data (JSON)</h3>
                <button class="btn btn-gray btn-sm" style="width:100%" onclick="exportToClipboard()">ç¾åœ¨ã®è¨­å®šã‚’ã‚³ãƒ”ãƒ¼</button>
                <div class="row" style="margin-top:10px;">
                    <textarea id="jsonInput" style="height:40px; font-size:0.7rem;" placeholder="JSONã‚’ã“ã“ã«è²¼ã‚Šä»˜ã‘"></textarea>
                </div>
                <button class="btn btn-gray btn-sm" style="width:100%; margin-top:5px;" onclick="importFromJson()">JSONã‹ã‚‰èª­è¾¼</button>
            </div>
        </div>
    </div>
</div>

<div class="main">
    <div id="canvasWrapper" class="canvas-area">
        <canvas id="canvas" width="128" height="128"></canvas>
    </div>
    
    <button class="btn btn-green" style="width:300px; margin-top:30px; padding:15px; font-size:1.2rem;" onclick="downloadImage()">PNGã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
    <p style="color:var(--muted); font-size:0.8rem; margin-top:10px;">è·äººãƒ¢ãƒ¼ãƒ‰ã§ã¯æ–‡å­—ã‚’ç›´æ¥ãƒ‰ãƒ©ãƒƒã‚°ã§ãã¾ã™</p>
</div>

<script>
// --- State & Core ---
let state = {
    text: "æœ€å¼·\nçµµæ–‡å­—", font: "'Dela Gothic One'", weight: 900,
    size: 120, lineHeight: 0.85, skew: 0,
    colors: ['#FFFFFF', '#00CCFF', '#0066FF'], rainbow: false, angle: 90,
    bg: { type: 'none', color: '#000000' },
    strokes: [{ color: '#000000', width: 6 }, { color: '#FFFFFF', width: 10 }],
    texture: 'none', neon: false,
    chars: [] 
};

const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
let selectedIdx = -1;
let lastScale = 1;

function init() {
    loadPresetsFromStorage();
    setupInputs();
    updateCharGrid();
    draw();
    
    // Drag and Drop
    canvas.addEventListener('mousedown', onStartDrag);
    window.addEventListener('mousemove', onDrag);
    window.addEventListener('mouseup', () => dragging = false);
}

function setupInputs() {
    const bind = (id, prop, event='input', isCheck=false) => {
        const el = document.getElementById(id);
        el.addEventListener(event, (e) => {
            const val = isCheck ? e.target.checked : e.target.value;
            setDeepProp(state, prop, val);
            if(id === 'textInput') updateCharGrid();
            draw();
        });
    };

    bind('textInput', 'text');
    bind('fontFamily', 'font');
    bind('fontWeight', 'weight');
    bind('globalSize', 'size');
    bind('lineHeight', 'lineHeight');
    bind('skew', 'skew');
    bind('col1', 'colors.0');
    bind('col2', 'colors.1');
    bind('col3', 'colors.2');
    bind('gradAngle', 'angle');
    bind('useRainbow', 'rainbow', 'change', true);
    bind('bgType', 'bg.type', 'change');
    bind('bgColor', 'bg.color');
    bind('textureMode', 'texture', 'change');
    bind('useNeon', 'neon', 'change', true);
    
    // Craft Detail
    bind('c_scale', 'chars.SELECTED.scale');
    bind('c_rot', 'chars.SELECTED.rot');
    bind('c_useCol', 'chars.SELECTED.useCol', 'change', true);
    bind('c_col', 'chars.SELECTED.col');
}

function setDeepProp(obj, path, val) {
    if(path.includes('SELECTED')) {
        if(selectedIdx < 0) return;
        path = path.replace('SELECTED', selectedIdx);
    }
    const parts = path.split('.');
    let t = obj;
    for(let i=0; i<parts.length-1; i++) t = t[parts[i]];
    t[parts[parts.length-1]] = val;
}

// --- Drawing ---
function draw() {
    ctx.clearRect(0, 0, 128, 128);
    const lines = state.text.split('\n');
    ctx.font = `${state.weight} ${state.size}px ${state.font}`;
    
    // Calc Auto-Scale
    let maxW = 0;
    lines.forEach(l => {
        const w = ctx.measureText(l).width + Math.abs(state.size * Math.tan(state.skew * Math.PI/180));
        if(w > maxW) maxW = w;
    });
    const contentH = lines.length * state.size * state.lineHeight;
    lastScale = Math.min(110/(maxW+20), 110/(contentH+20), 1.0);

    ctx.save();
    ctx.translate(64, 64);
    ctx.scale(lastScale, lastScale);

    // Zabuton
    if(state.bg.type !== 'none') {
        ctx.fillStyle = state.bg.color;
        ctx.beginPath();
        if(state.bg.type==='rect') ctx.rect(-70, -70, 140, 140);
        else if(state.bg.type==='round') ctx.roundRect(-65, -65, 130, 130, 20);
        else if(state.bg.type==='burst') {
            for(let i=0; i<20; i++) {
                const a = (i/20)*Math.PI*2;
                const r = i%2===0 ? 80 : 40;
                ctx.lineTo(Math.cos(a)*r, Math.sin(a)*r);
            }
        }
        ctx.fill();
    }

    const startY = -((lines.length-1)*state.size*state.lineHeight)/2;
    let charIdx = 0;

    // Layer Pass
    const render = (mode, sIdx) => {
        let currentIdx = 0;
        lines.forEach((line, li) => {
            const lw = ctx.measureText(line).width;
            let x = -lw/2;
            const y = startY + li * state.size * state.lineHeight;
            
            Array.from(line).forEach(char => {
                const cw = ctx.measureText(char).width;
                if(!state.chars[currentIdx]) state.chars[currentIdx] = {x:0, y:0, scale:1, rot:0, useCol:false, col:'#ff0000'};
                const c = state.chars[currentIdx];

                ctx.save();
                ctx.translate(x + cw/2 + c.x, y + c.y);
                ctx.transform(1, 0, Math.tan(state.skew * Math.PI/180), 1, 0, 0);
                ctx.rotate(c.rot * Math.PI/180);
                ctx.scale(c.scale, c.scale);

                if(mode==='neon' && state.neon) {
                    ctx.shadowColor = state.colors[1]; ctx.shadowBlur = 15;
                    ctx.fillStyle = state.colors[1]; ctx.fillText(char, 0, 0);
                } else if(mode==='stroke') {
                    let total = 0; for(let i=0; i<=sIdx; i++) total += state.strokes[i].width;
                    ctx.strokeStyle = state.strokes[sIdx].color;
                    ctx.lineWidth = total * 2; ctx.lineJoin = 'round';
                    ctx.strokeText(char, 0, 0);
                } else if(mode==='fill') {
                    if(c.useCol) ctx.fillStyle = c.col;
                    else if(state.rainbow) ctx.fillStyle = `hsl(${(currentIdx*40)%360}, 100%, 50%)`;
                    else {
                        const g = ctx.createLinearGradient(0, -state.size/2, 0, state.size/2);
                        g.addColorStop(0, state.colors[0]); g.addColorStop(0.5, state.colors[1]); g.addColorStop(1, state.colors[2]);
                        ctx.fillStyle = g;
                    }
                    ctx.fillText(char, 0, 0);
                }
                ctx.restore();
                x += cw; currentIdx++;
            });
        });
    };

    if(state.neon) render('neon');
    for(let i=state.strokes.length-1; i>=0; i--) render('stroke', i);
    render('fill');
    ctx.restore();

    // Texture
    if(state.texture !== 'none') {
        ctx.save(); ctx.globalCompositeOperation = 'source-atop'; ctx.globalAlpha = 0.3;
        if(state.texture==='noise') {
            for(let i=0; i<1000; i++) { ctx.fillStyle=Math.random()>0.5?'#fff':'#000'; ctx.fillRect(Math.random()*128, Math.random()*128, 1, 1); }
        } else if(state.texture==='gloss') {
            const g = ctx.createLinearGradient(0,0,128,128); g.addColorStop(0, '#fff'); g.addColorStop(1, 'transparent');
            ctx.fillStyle = g; ctx.fillRect(0,0,128,128);
        }
        ctx.restore();
    }
    document.getElementById('previewImg').src = canvas.toDataURL();
}

// --- Presets & Storage ---
let presets = {};
function saveCurrentToPresets() {
    const name = document.getElementById('presetNameInput').value.trim();
    if(!name) return alert('åå‰ã‚’å…¥ã‚Œã¦ãã ã•ã„');
    presets[name] = JSON.parse(JSON.stringify(state));
    localStorage.setItem('emoji_presets_v3', JSON.stringify(presets));
    renderPresetList();
    document.getElementById('presetNameInput').value = '';
}

function loadPresetsFromStorage() {
    const saved = localStorage.getItem('emoji_presets_v3');
    if(saved) presets = JSON.parse(saved);
    renderPresetList();
}

function renderPresetList() {
    const list = document.getElementById('presetList');
    list.innerHTML = '';
    Object.keys(presets).forEach(name => {
        const div = document.createElement('div');
        div.className = 'preset-item';
        div.innerHTML = `
            <span class="preset-name" onclick="applyPreset('${name}')">${name}</span>
            <button class="btn btn-red btn-sm" onclick="deletePreset('${name}')">å‰Šé™¤</button>
        `;
        list.appendChild(div);
    });
}

function applyPreset(name) {
    const target = presets[name];
    state = JSON.parse(JSON.stringify(target));
    // UIåæ˜ ï¼ˆæœ¬å½“ã¯å…¨é …ç›®æ›¸ãã¹ãã ãŒã€é‡è¦ãªã®ã ã‘ï¼‰
    document.getElementById('textInput').value = state.text;
    document.getElementById('fontFamily').value = state.font;
    updateCharGrid();
    draw();
}

function deletePreset(name) {
    delete presets[name];
    localStorage.setItem('emoji_presets_v3', JSON.stringify(presets));
    renderPresetList();
}

function exportToClipboard() {
    const str = JSON.stringify(state);
    navigator.clipboard.writeText(str);
    alert('è¨­å®šJSONã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
}

function importFromJson() {
    try {
        const json = document.getElementById('jsonInput').value;
        state = JSON.parse(json);
        updateCharGrid();
        draw();
        alert('èª­ã¿è¾¼ã¿å®Œäº†');
    } catch(e) { alert('ä¸æ­£ãªå½¢å¼ã§ã™'); }
}

// --- Interaction ---
function setTab(t) {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(`tab-btn-${t}`).classList.add('active');
    document.querySelectorAll('.tab-pane').forEach(p => p.classList.add('hidden'));
    document.getElementById(`pane-${t}`).classList.remove('hidden');
    document.getElementById('canvasWrapper').classList.toggle('interactive', t==='craft');
}

function updateCharGrid() {
    const grid = document.getElementById('charGrid');
    grid.innerHTML = '';
    const chars = Array.from(state.text.replace(/\n/g, ''));
    chars.forEach((c, i) => {
        const b = document.createElement('div');
        b.style.cssText = "width:30px; height:30px; background:#444; display:flex; align-items:center; justify-content:center; cursor:pointer; border-radius:4px;";
        if(selectedIdx === i) b.style.border = "2px solid var(--accent)";
        b.innerText = c;
        b.onclick = () => { selectedIdx = i; updateCharGrid(); showCharDetail(); };
        grid.appendChild(b);
    });
}

function showCharDetail() {
    const c = state.chars[selectedIdx];
    const pane = document.getElementById('charDetail');
    pane.style.opacity = 1; pane.style.pointerEvents = 'auto';
    document.getElementById('selCharName').innerText = `æ–‡å­—: ${state.text.replace(/\n/g,'')[selectedIdx]}`;
    document.getElementById('c_scale').value = c.scale;
    document.getElementById('c_rot').value = c.rot;
    document.getElementById('c_useCol').checked = c.useCol;
    document.getElementById('c_col').value = c.col;
}

// --- Drag & Drop ---
let dragging = false;
function onStartDrag(e) {
    if(document.getElementById('tab-btn-craft').classList.contains('active') && selectedIdx >= 0) {
        dragging = true;
    }
}
function onDrag(e) {
    if(!dragging) return;
    const rect = canvas.getBoundingClientRect();
    const mx = (e.clientX - rect.left) / rect.width * 128;
    const my = (e.clientY - rect.top) / rect.height * 128;
    state.chars[selectedIdx].x = (mx - 64) / lastScale;
    state.chars[selectedIdx].y = (my - 64) / lastScale;
    draw();
}

function addStroke() {
    state.strokes.unshift({color:'#ffffff', width:5});
    renderStrokeList(); draw();
}
function renderStrokeList() {
    const list = document.getElementById('strokeList');
    list.innerHTML = '';
    state.strokes.forEach((s, i) => {
        const d = document.createElement('div');
        d.className = 'row';
        d.innerHTML = `<input type="color" value="${s.color}" oninput="state.strokes[${i}].color=this.value;draw()"><input type="range" max="30" value="${s.width}" oninput="state.strokes[${i}].width=parseInt(this.value);draw()"><button class="btn btn-red btn-sm" onclick="state.strokes.splice(${i},1);renderStrokeList();draw()">Ã—</button>`;
        list.appendChild(d);
    });
}

function randomize() {
    state.chars.forEach(c => { c.x=(Math.random()-0.5)*40; c.y=(Math.random()-0.5)*40; c.rot=(Math.random()-0.5)*60; });
    draw();
}
function copyToAll() {
    const src = JSON.parse(JSON.stringify(state.chars[selectedIdx]));
    state.chars.forEach((c, i) => { if(i!==selectedIdx) state.chars[i] = {...src}; });
    draw();
}

function downloadImage() {
    const a = document.createElement('a'); a.download='emoji.png'; a.href=canvas.toDataURL(); a.click();
}

window.onload = () => { init(); renderStrokeList(); };
</script>
</body>
</html>
